import discord
from discord.ext import commands
import re

# Bot setup with necessary intents
intents = discord.Intents.default()
intents.message_content = True
intents.members = True

bot = commands.Bot(command_prefix='!', intents=intents)

# Add your role IDs (right-click role → Copy ID with Developer Mode on)
ALLOWED_ROLES = [
    825867756549177354,  # Admin role
    1441336025052872776,  # Owner role
    1444077767426572378,  # Developer role
]

# Regex patterns to detect Discord invite links
DISCORD_INVITE_PATTERNS = [
    r'discord\.gg/[a-zA-Z0-9]+',
    r'discord\.com/invite/[a-zA-Z0-9]+',
    r'discordapp\.com/invite/[a-zA-Z0-9]+',
]

def has_allowed_role(member):
    """Check if member has any of the allowed roles"""
    if member.guild_permissions.administrator:
        return True
    return any(role.id in ALLOWED_ROLES for role in member.roles)

def contains_discord_invite(message_content):
    """Check if message contains a Discord invite link"""
    for pattern in DISCORD_INVITE_PATTERNS:
        if re.search(pattern, message_content, re.IGNORECASE):
            return True
    return False

@bot.event
async def on_ready():
    print(f'{bot.user} has connected to Discord!')
    print(f'Bot is in {len(bot.guilds)} server(s)')
    await bot.change_presence(activity=discord.Game(name="Monitoring invite links"))

@bot.event
async def on_message(message):
    # Ignore bot's own messages
    if message.author == bot.user:
        return
    
    # Ignore DMs
    if not message.guild:
        return
    
    # Check if message contains Discord invite link
    if contains_discord_invite(message.content):
        # Check if user has allowed role
        if not has_allowed_role(message.author):
            try:
                # Delete the message
                await message.delete()
                
                # Send warning message
                warning = await message.channel.send(
                    f"{message.author.mention}, you don't have permission to post Discord invite links!"
                )
                
                # Optional: Delete warning after 5 seconds
                await warning.delete(delay=5)
                
                # Log to console
                print(f"Deleted invite link from {message.author} in #{message.channel.name}")
                
            except discord.Forbidden:
                print(f"Missing permissions to delete message in #{message.channel.name}")
            except Exception as e:
                print(f"Error deleting message: {e}")
    
    # Process commands
    await bot.process_commands(message)

@bot.command(name='checkperms')
async def check_permissions(ctx):
    """Check if you have permission to post invite links"""
    if has_allowed_role(ctx.author):
        await ctx.send(f"{ctx.author.mention}, you have permission to post Discord invite links! ✅")
    else:
        await ctx.send(f"{ctx.author.mention}, you don't have permission to post Discord invite links. ❌")

@bot.command(name='ping')
async def ping(ctx):
    """Check bot latency"""
    await ctx.send(f'Pong! Latency: {round(bot.latency * 1000)}ms')

# Replace this with your actual bot token
bot.run('MTQ0NDg0MzcwNDk2MjUxNDk4NA.GnbO9V.ZEU2fwarj-HmZ2qxUNUe-98REXDSDcuu73tQW0')
